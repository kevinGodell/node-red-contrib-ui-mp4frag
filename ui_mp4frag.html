<script type="text/javascript">
  const HLS_JS_CONFIG = {
    liveDurationInfinity: true,
    liveBackBufferLength: 0,
    maxBufferLength: 5,
    manifestLoadingTimeOut: 1000,
    manifestLoadingMaxRetry: 10,
    manifestLoadingRetryDelay: 500,
  };

  const PLAYERS = ['socket.io', 'hls.js', 'hls', 'mp4'];

  const valToBool = val => {
    if (typeof val === 'string') {
      return val === 'true';
    }
    if (typeof val === 'boolean') {
      return val;
    }
    return false;
  };

  // register node
  RED.nodes.registerType('ui_mp4frag', {
    align: 'left',
    category: 'cctv',
    color: '#DEBD5C',
    defaults: {
      name: {
        value: '',
      },
      group: {
        type: 'ui_group',
        required: true,
      },
      order: {
        value: 0,
      },
      width: {
        value: 5,
        validate: function (width) {
          const group = $('#node-input-group').val() || this.group;
          const groupNode = RED.nodes.node(group);
          const valid = !groupNode || +groupNode.width >= +width;
          $('#node-input-size').toggleClass('input-error', !valid);
          return valid;
        },
      },
      height: {
        value: 4,
      },
      readyPoster: {
        value: 'https://raw.githubusercontent.com/kevinGodell/node-red-contrib-ui-mp4frag/master/video_playback_ready.png',
      },
      errorPoster: {
        value: 'https://raw.githubusercontent.com/kevinGodell/node-red-contrib-ui-mp4frag/master/video_playback_error.png',
      },
      hlsJsConfig: {
        value: JSON.stringify(HLS_JS_CONFIG),
        validate: RED.validators.typedInput('json'),
      },
      retry: {
        value: true,
        validate: function (retry) {
          this.retry = valToBool(retry);
          return true;
        },
      },
      play: {
        value: true,
        validate: function (play) {
          this.play = valToBool(play);
          return true;
        },
      },
      unload: {
        value: true,
        validate: function (unload) {
          this.unload = valToBool(unload);
          return true;
        },
      },
      players: {
        value: PLAYERS,
        validate: function (players) {
          return Array.isArray(players) && players.length > 0;
        },
      },
    },
    icon: 'font-awesome/fa-file-video-o',
    inputLabels: 'widget input',
    inputs: 1,
    label: function () {
      return this.name || 'ui_mp4frag';
    },
    outputLabels: 'widget output',
    outputs: 1,
    oneditprepare: function () {
      $('#node-input-size').elementSizer({
        width: '#node-input-width',
        height: '#node-input-height',
        group: '#node-input-group',
      });

      $('#uiMp4fragHlsJsUrl')
        .val(RED.settings.uiMp4fragHlsJsUrl)
        .prop('readonly', true)
        .on('click', () => {
          RED.notify(this._('ui_mp4frag.warning.hls_js_url'), { type: 'warning', id: 'ui_mp4frag' });
          // type/color: error = red, warning = orange, success = green, '' = blue
        });

      $('#node-input-play').typedInput({ types: ['bool'] });

      $('#node-input-retry').typedInput({ types: ['bool'] });

      $('#node-input-unload').typedInput({ types: ['bool'] });

      $('#node-input-hlsJsConfig').typedInput({ types: ['json'] });

      const rowHtml = (index, data) => {
        return `<div style="margin-left: 18px; width: 150px; display: inline-grid">${index + 1}</div><div style="display: inline-grid">${data}</div>`;
      };

      const players = $('#node-input-players-container').editableList({
        header: $('<div>').append($.parseHTML('<div style="margin-left: 40px; width: 150px; display: inline-grid">Order</div><div style="display: inline-grid">Player</div>')),
        addItem: function (row, index, data) {
          $(row).html(rowHtml(index, data));
        },
        sortItems: function (items) {
          items.each((index, row) => {
            row.html(rowHtml(index, row.data('data')));
          });
        },
        addButton: false,
        sortable: true,
        // removable: true
      });

      if (Array.isArray(this.players) === true && this.players.length > 0) {
        this.players.forEach(player => {
          if (typeof player === 'string') {
            players.editableList('addItem', player);
          }
        });
      } else {
        players.editableList('addItems', PLAYERS);
      }

      $('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-book"></i> help</button>')
        .on('click', () => {
          RED.sidebar.help.show('ui_mp4frag');
        })
        .appendTo($('div.red-ui-tray-footer'));
    },
    oneditsave: function () {
      const items = $('#node-input-players-container').editableList('items');

      this.players = [];
      items.each((index, row) => {
        this.players.push(row.data('data'));
      });
    },
  });
</script>

<script data-template-name="ui_mp4frag" type="text/html">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>

  <div class="form-row" id="template-row-group">
    <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
    <input type="text" id="node-input-group" />
  </div>

  <div class="form-row" id="template-row-size">
    <label for="node-input-size"><i class="fa fa-object-group"></i> Size</label>
    <button class="editor-button" id="node-input-size"></button>
    <input type="hidden" id="node-input-width" />
    <input type="hidden" id="node-input-height" />
  </div>

  <fieldset>
    <legend>Player Order</legend>

    <div class="form-row">
      <ol id="node-input-players-container"></ol>
    </div>
  </fieldset>

  <fieldset>
    <legend>Video Options</legend>

    <div class="form-row">
      <label for="node-input-play"><i class="fa fa-play"></i> Play</label>
      <input type="text" id="node-input-play" />
    </div>

    <div class="form-row">
      <label for="node-input-unload"><i class="fa fa-eye"></i> Unload</label>
      <input type="text" id="node-input-unload" />
    </div>

    <div class="form-row">
      <label for="node-input-retry"><i class="fa fa-repeat"></i> Retry</label>
      <input type="text" id="node-input-retry" />
    </div>

    <div class="form-row">
      <label for="node-input-readyPoster"><i class="fa fa-picture-o"></i> Ready</label>
      <input type="text" id="node-input-readyPoster" />
    </div>

    <div class="form-row">
      <label for="node-input-errorPoster"><i class="fa fa-picture-o"></i> Error</label>
      <input type="text" id="node-input-errorPoster" />
    </div>
  </fieldset>

  <fieldset>
    <legend>HLS.js Options</legend>

    <div class="form-row">
      <label for="uiMp4fragHlsJsUrl"><i class="fa fa-book"></i> URL</label>
      <input type="text" id="uiMp4fragHlsJsUrl" />
    </div>

    <div class="form-row">
      <label for="node-input-hlsJsConfig"><i class="fa fa-cog"></i> Config</label>
      <input type="text" id="node-input-hlsJsConfig" />
    </div>
  </fieldset>
</script>

<script data-help-name="ui_mp4frag" type="text/html">
  <h2>Play fragmented mp4 video on supported browsers.</h2>
  <p>The ui video player loads after receiving a message with the payload set as an HLS Playlist, Socket.io Connection, or mp4 video path.</p>
  <h3>Example message payloads</h3>
  <pre class="form-tips"><code>{
  // hls playlist
  payload: '/mp4frag/example/hls.m3u8'
}</code></pre>
  <pre class="form-tips"><code>{
  // mp4 video path
  payload: '/mp4frag/example/video.mp4'
}</code></pre>
  <pre class="form-tips"><code>{
  // multiple video sources
  payload: {
    hlsPlaylist: '/mp4frag/example/hls.m3u8',
    socketIo: {
      path: '/mp4frag/socket.io',
      namespace: '/example',
    },
    mp4Video: '/mp4frag/example/video.mp4'
  }
}</code></pre>
  <h3>Player Order</h3>
  <p>
    This will determine which video player library or type to use. It will check the payload for available video sources that are compatible with the current browser based on the selected order. If
    receiving a payload with multiple video sources, it will use the first compatible type found.
  </p>
  <h3>Video Play</h3>
  <p>Play video after source is loaded.</p>
  <h3>Video Unload</h3>
  <p>Unload source if player is not visible.</p>
  <h3>Video Retry (option not implemented)</h3>
  <p>Retry loading source if fatal error occurs.</p>
  <h3>Video Ready</h3>
  <p>Image to show as video poster after initialized. It can be a url or base 64 encoded image.</p>
  <h3>Video Error</h3>
  <p>Image to show as video poster after fatal error. It can be a url or base 64 encoded image.</p>
  <h3>HLS.js URL</h3>
  <p>Path to the HLS.js library. Must be set in the settings.js file.</p>
  <p><code class="form-tips">uiMp4fragHlsJsUrl: 'url_to_lib_hls.js'</code></p>
  <h3>HLS.js Config</h3>
  <p>
    Configuration object passed to a new Hls instance. For a list of available options, please see the
    <a target="_blank" href="https://github.com/video-dev/hls.js/blob/master/docs/API.md#fine-tuning">hls.js docs</a>.
  </p>
</script>
