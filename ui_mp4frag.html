<script type="text/javascript">
  const HLS_JS_CONFIG = {
    liveDurationInfinity: true,
    liveBackBufferLength: 0,
    maxBufferLength: 5,
    manifestLoadingTimeOut: 1000,
    manifestLoadingMaxRetry: 10,
    manifestLoadingRetryDelay: 500,
  };

  // register node
  RED.nodes.registerType('ui_mp4frag', {
    align: 'left',
    category: 'cctv',
    color: '#DEBD5C',
    defaults: {
      name: {
        value: '',
      },
      group: {
        type: 'ui_group',
        required: true,
      },
      order: {
        value: 0,
      },
      width: {
        value: 5,
        validate: function (width) {
          const group = $('#node-input-group').val() || this.group;
          const groupNode = RED.nodes.node(group);
          const valid = !groupNode || +groupNode.width >= +width;
          $('#node-input-size').toggleClass('input-error', !valid);
          return valid;
        },
      },
      height: {
        value: 4,
      },
      readyPoster: {
        value: 'https://raw.githubusercontent.com/kevinGodell/node-red-contrib-ui-mp4frag/master/video_playback_ready.png',
      },
      errorPoster: {
        value: 'https://raw.githubusercontent.com/kevinGodell/node-red-contrib-ui-mp4frag/master/video_playback_error.png',
      },
      hlsJsConfig: {
        value: JSON.stringify(HLS_JS_CONFIG),
        validate: RED.validators.typedInput('json'),
      },
      restart: {
        value: true,
        validate: RED.validators.typedInput('bool'),
      },
      autoplay: {
        value: true,
        validate: RED.validators.typedInput('bool'),
      },
    },
    icon: 'font-awesome/fa-file-video-o',
    inputLabels: 'widget input',
    inputs: 1,
    label: function () {
      return this.name || 'ui_mp4frag';
    },
    outputLabels: 'widget output',
    outputs: 1,
    oneditprepare: function () {
      $('#node-input-size').elementSizer({
        width: '#node-input-width',
        height: '#node-input-height',
        group: '#node-input-group',
      });

      $('#uiMp4fragHlsJsUrl')
        .val(RED.settings.uiMp4fragHlsJsUrl)
        .prop('readonly', true)
        .on('click', () => {
          RED.notify(this._('ui_mp4frag.warning.hls_js_url'), { type: 'warning', id: 'ui_mp4frag' });
          // type/color: error = red, warning = orange, success = green, '' = blue
        });

      $('#node-input-autoplay').typedInput({ types: ['bool'] });

      $('#node-input-restart').typedInput({ types: ['bool'] });

      $('#node-input-hlsJsConfig').typedInput({ types: ['json'] });

      $('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-book"></i> help</button>')
        .on('click', () => {
          RED.sidebar.help.show('ui_mp4frag');
        })
        .appendTo($('div.red-ui-tray-footer'));
    },
    oneditsave: function () {},
  });
</script>

<script data-template-name="ui_mp4frag" type="text/html">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>

  <div class="form-row" id="template-row-group">
    <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
    <input type="text" id="node-input-group" />
  </div>

  <div class="form-row" id="template-row-size">
    <label for="node-input-size"><i class="fa fa-object-group"></i> Size</label>
    <button class="editor-button" id="node-input-size"></button>
    <input type="hidden" id="node-input-width" />
    <input type="hidden" id="node-input-height" />
  </div>

  <fieldset>
    <legend>Video Options</legend>

    <div class="form-row">
      <label for="node-input-autoplay"><i class="fa fa-play"></i> Autoplay</label>
      <input type="text" id="node-input-autoplay" />
    </div>

    <div class="form-row">
      <label for="node-input-restart"><i class="fa fa-repeat"></i> Restart</label>
      <input type="text" id="node-input-restart" />
    </div>

    <div class="form-row">
      <label for="node-input-readyPoster"><i class="fa fa-picture-o"></i> Ready</label>
      <input type="text" id="node-input-readyPoster" />
    </div>

    <div class="form-row">
      <label for="node-input-errorPoster"><i class="fa fa-picture-o"></i> Error</label>
      <input type="text" id="node-input-errorPoster" />
    </div>
  </fieldset>

  <fieldset>
    <legend>HLS.js Options</legend>

    <div class="form-row">
      <label for="uiMp4fragHlsJsUrl"><i class="fa fa-book"></i> URL</label>
      <input type="text" id="uiMp4fragHlsJsUrl" />
    </div>

    <div class="form-row">
      <label for="node-input-hlsJsConfig"><i class="fa fa-cog"></i> Config</label>
      <input type="text" id="node-input-hlsJsConfig" />
    </div>
  </fieldset>
</script>

<script data-help-name="ui_mp4frag" type="text/html">
  <h2>Play HLS video using HLS.js or native HLS on supported browsers.</h2>
  <p>After receiving a msg with the payload set as an HLS Playlist, it will trigger the ui video player to load.</p>
  <p><code class="form-tips">{ payload: '/mp4frag/example/hls.m3u8' }</code></p>
  <p>
    The video player first tries to use HLS.js to play the video on supported browsers. If HLS.js is not supported, the video player will
    fall back to trying native HLS. If neither is supported by the browser, an error message will be shown.
  </p>
  <h3>Video Autoplay (option not implemented)</h3>
  <p>Start playing the video after the source is loaded.</p>
  <h3>Video Restart (option not implemented)</h3>
  <p>If fatal errors occur, reload video source.</p>
  <h3>Video Ready</h3>
  <p>Image to show as video poster after initialized. It can be a url or base 64 encoded image.</p>
  <h3>Video Error</h3>
  <p>Image to show as video poster after fatal error. It can be a url or base 64 encoded image.</p>
  <h3>HLS.js URL</h3>
  <p>Path to the HLS.js library. Must be set in the settings.js file.</p>
  <p><code class="form-tips">uiMp4fragHlsJsUrl: 'url_to_lib_hls.js'</code></p>
  <h3>HLS.js Config</h3>
  <p>
    Configuration object passed to a new Hls instance. For a list of available options, please see the
    <a target="_blank" href="https://github.com/video-dev/hls.js/blob/master/docs/API.md#fine-tuning">hls.js docs</a>.
  </p>
</script>
